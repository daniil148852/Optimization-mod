name: Build UltraLite Mod

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create Release? (yes/no)'
        required: false
        default: 'no'

jobs:
  build:
    name: Build Mod
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # –ï—Å–ª–∏ gradle wrapper –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º
      - name: Ensure Gradle Wrapper exists
        run: |
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "Gradle wrapper not found, generating..."
            mkdir -p gradle/wrapper
            
            # –°–∫–∞—á–∏–≤–∞–µ–º gradle
            wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip
            unzip -q gradle-8.6-bin.zip
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º wrapper
            ./gradle-8.6/bin/gradle wrapper --gradle-version 8.6
            
            # –û—á–∏—â–∞–µ–º
            rm -rf gradle-8.6-bin.zip gradle-8.6
            
            echo "Gradle wrapper generated successfully"
          else
            echo "Gradle wrapper already exists"
          fi

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Build
        run: |
          chmod +x gradlew
          ./gradlew build --no-daemon --stacktrace 2>&1 | tee build.log

      - name: Build Summary
        if: always()
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          if [ -d "build/libs" ]; then
            echo "### ‚úÖ Build Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            for f in build/libs/*.jar; do
              size=$(du -h "$f" | cut -f1)
              name=$(basename "$f")
              echo "| \`$name\` | $size |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download from **Artifacts** section below ‚¨áÔ∏è" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Build Failed!" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: UltraLite-Mod-${{ github.run_number }}
          path: |
            build/libs/*.jar
            !build/libs/*-sources.jar
          retention-days: 90

      - name: Create Release
        if: success() && github.event.inputs.create_release == 'yes'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: "UltraLite v1.0.${{ github.run_number }}"
          body: |
            ## üöÄ UltraLite Optimization Mod

            **Minecraft:** 1.20.1 | **Loader:** Fabric | **Target:** Unisoc T606

            ### üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ FCL:
            1. –°–∫–∞—á–∞–π—Ç–µ `.jar` —Ñ–∞–π–ª –Ω–∏–∂–µ
            2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ –ø–∞–ø–∫—É `mods/`
            3. –ù—É–∂–µ–Ω Fabric Loader + Fabric API
            4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–≥—Ä—É

            ### ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
            - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü, –æ–±–ª–∞–∫–æ–≤, –¥–æ–∂–¥—è
            - Entity culling (–º–∞–∫—Å 32 —Å—É—â–Ω–æ—Å—Ç–∏)
            - Chunk culling (–∑–∞ —Å–ø–∏–Ω–æ–π –∏–≥—Ä–æ–∫–∞)
            - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –¥–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ä–∏—Å–æ–≤–∫–∏
            - –ó–∞–º–æ—Ä–æ–∑–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π —Ç–µ–∫—Å—Ç—É—Ä
            - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
            - –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
          files: build/libs/*.jar
